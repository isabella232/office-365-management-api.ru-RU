---
ms.technology: o365-service-communications
ms.TocTitle: Troubleshooting the Office 365 Management Activity API
title: Устранение неполадок, связанных с API действий управления Office 365
description: Сводка по наиболее распространенным вопросам об API действий управления Office 365, задаваемым службе поддержки Майкрософт.
ms.ContentId: 50822603-a1ec-a754-e7dc-67afe36bb1b0
ms.topic: reference (API)
ms.date: ''
localization_priority: Priority
ms.openlocfilehash: 086b40d0207fba761db66d918d74dc872ae66c9471ceced91d2b4b6dfe73ac1e
ms.sourcegitcommit: 88ef5f75a9e2a25760a2caa2cef1f51f9afba90c
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/05/2021
ms.locfileid: "54274352"
---
# <a name="office-365-management-activity-api-faqs-and-troubleshooting"></a>Вопросы и ответы по API действий управления Office 365, а также устранение неполадок, связанных с ним

API действий управления Office 365 (другое название — *API единого аудита*), входящий в состав предложений для обеспечения безопасности и соответствия требованиям в Office 365:

- предоставляет программный доступ к нескольким рабочим нагрузкам конвейера аудита (например, SharePoint и Exchange);

- является основным интерфейсом, который используют различные продукты от сторонних поставщиков, чтобы агрегировать и индексировать данные аудита.

API действий управления не следует путать с API связи со службой Office 365. API действий управления используется для аудита действий пользователей в различных рабочих нагрузках. API связи со службой предназначен для аудита состояния и сообщений, отправляемых службами, которые доступны в Office 365 (например, Dynamics CRM или службой идентификации).
 
> [!NOTE]
> С 22 октября 2020 г. по 6 ноября 2020 г. имелась проблема, из-за которой тип контента Audit.AzureActiveDirectory был недоступен с помощью API действий управления Office 365. Эта проблема не влияла на события входа Azure AD. Недоступные события в затронутый период станут доступны в течение ближайших дней, а завершение исправления ожидается не позднее 20 ноября 2020 г. В некоторых случаях клиенты могут заметить дублирующиеся данные событий, созданных с 26 октября 2020 г. по 5 ноября 2020 г.

## <a name="frequently-asked-questions-about-the-office-365-management-activity-api"></a>API действий управления Office 365: вопросы и ответы

**Как подключиться к API действий управления?**

Сведения о том, как начать работу с API действий управления Office 365, см. в статье [Начало работы с API управления Office 365](get-started-with-office-365-management-apis.md).

**Что произойдет, если я отключу аудит для своей организации Office 365? Буду ли я по-прежнему получать события через API действий управления?**

Нет. Чтобы получать записи через API действий управления, необходимо включить единый аудит Office 365 для своей организации. Инструкции см. в статье [Включение и отключение поиска в журнале аудита](https://docs.microsoft.com/microsoft-365/compliance/turn-audit-log-search-on-or-off).

**В случае каких событий проводится аудит для определенной службы Office 365?**

В документации по схеме API действий управления Office 365 приведен полный список событий. Дополнительные сведения см. в статье "Схема API действий управления Office 365". Кроме того, в статье[Поиск по журналу аудита в Центре безопасности и соответствия требованиям](https://docs.microsoft.com/microsoft-365/compliance/search-the-audit-log-in-security-and-compliance#audited-activities) в разделе "Подлежащие аудиту действия" приводится список событий для большинства служб Office 365, которые подлежат аудиту.

**Есть ли разница между записями, которые получены API действий управления, и записями, которые возвращены средством поиска в журналах аудита, доступным в Центре соответствия требованиям Microsoft 365?**

В обоих случаях возвращаются одни и те же данные. Единственное отличие заключается в том, что с помощью API можно получить данные только за последние 7 дней (дополнительные сведения см. в вопросах ниже). При поиске в журнале аудита в Центре безопасности и соответствия требованиям (или при использовании соответствующего командлета **Search-UnifiedAuditLog** в Exchange Online PowerShell) вы можете получить данные за период хранения, действующий в момент создания данных (например, 90 дней или год).

**Каков максимальный период ожидания отправки уведомления о том или ином событии Office 365?**

Не существует гарантированной максимальной задержки для доставки уведомлений (другими словами, отсутствует соглашение об уровне обслуживания). Обычно большинство уведомлений отправляются в течение одного часа после события. Чаще задержка намного меньше, но этот период может быть дольше, так как это зависит от рабочей нагрузки.

**Разве использование уведомлений веб-перехватчиков не предполагает более быстрое получение результатов?**

Нет. В последнее время период ожидания уведомлений при использовании веб-перехватчиков был дольше, чем в случае отправки API запросов непосредственно с помощью операции `/content`.

**Как долго контент будет оставаться доступным для получения через API?**

Контент доступен для получения через API в течение 7 дней после отправки уведомления о его доступности. Даже если уведомление задерживается на непривычно долгое время (например, при перебоях в работе службы), у вас все равно останется 7 дней после появления уведомления, чтобы скачать объект, связанный с первоначальным событием.

**Можно ли запросить у API действий управления определенный ИД события, RecordType или другие свойства большого двоичного объекта контента?**

Нет. API действий управления предоставляет все подробные сведения о событии для определенного журнала. Его можно использовать для скачивания всех сведений, а затем реализовать собственную логику запроса для скачанных данных. Например, с помощью настраиваемого приложения или стороннего средства.

**Как убедиться, что данные, поступающие из имеющегося решения для аудита, которое собирает данные из API действий управления, являются точными и полными?**

Краткий ответ — корпорация Майкрософт не предоставляет никакого журнала, позволяющего проверить то или иное приложение либо стороннее решение. Существуют другие продукты от Майкрософт для обеспечения безопасности, которые получают свои данные из того же конвейера, но эти продукты не имеют отношения к данной теме, и с их помощью невозможно непосредственно проверить API действий управления. Если вас беспокоят несоответствия между данными, которые предоставляет имеющееся решение, и вашими ожиданиями, вам следует реализовать показанные выше операции. Однако это может быть сложно в зависимости от того, как имеющееся средство или решение перечисляет и индексирует данные. Если имеющееся решение только представляет данные, отсортированные по времени создания самого события, невозможно запросить API по времени создания события для сравнения наборов результатов. В этом случае вам придется собирать нужные большие двоичные объекты контента в течение нескольких дней, индексировать или сортировать их вручную, а затем выполнять сравнение вручную.

**Каково ограничение на регулирование для API действий управления?**

Для всех организаций изначально выделяется базовый уровень 2 000 запросов в минуту. Затем ограничение регулирования изменяется в зависимости от сочетания факторов, в том числе от количества мест в организации. Кроме того, организации Office 365 E5 и Microsoft 365 E5 получат примерно вдвое большую пропускную способность, чем организации без плана E5. Для защиты работоспособности службы также будет использоваться ограничение максимальной пропускной способности.

> [!NOTE]
> Хотя каждый клиент может изначально отправлять до 2 000 запросов в минуту, корпорация Майкрософт не может гарантировать скорость отклика. Она зависит от различных факторов, таких как производительность клиентской системы, а также мощность и скорость сети.

**У меня возникла ошибка регулирования в API действий управления. Что мне делать?**

Отправьте запрос в службу поддержки Майкрософт на увеличение максимального значения для регулирования, указав для этого коммерческое обоснование. Мы проанализируем запрос и в случае положительного решения увеличим максимальное значение для регулирования.

**Почему TargetUpdatedProperties больше не находятся в свойстве ExtendedProperties в журналах аудита для действий Azure Active Directory?**

TargetUpdatedProperties отображались в объекте ExtendedProperties. Однако они были удалены из свойства ExtendedProperties и теперь отображаются в свойстве ModifiedProperties.

**Почему журналы аудита со значением UserAccountNotFound свойства LogonError для действий при входе в Azure Active Directory (Azure AD) недоступны через API действий управления?**

Начиная с ноября 2020 г. журналы аудита для действий при входе в Azure AD включаются в единый журнал аудита из Центров событий Azure AD. В результате этого изменения заполнение свойства LogonError значением UserAccountNotFound невозможно. С первой недели февраля 2021 г. [свойство ErrorCode в схеме аудита входа в Azure AD](https://docs.microsoft.com/office/office-365-management-api/office-365-management-activity-api-schema#azure-active-directory-secure-token-service-sts-logon-schema) соответствует [кодам ошибок AADSTS](https://docs.microsoft.com/azure/active-directory/develop/reference-aadsts-error-codes#lookup-current-error-code-information). Кроме того, параметр UserId не будет заполняться именем пользователя из попытки входа для ошибок UserAccountNotFound, так как это имя пользователя не существует в каталоге Azure AD организации.

## <a name="troubleshooting-the-office-365-management-activity-api"></a>Устранение неполадок, связанных с API действий управления Office 365

Каждому, кто начинает работать с API действий управления Office 365, следует понимать, что в этом интерфейсе отсутствует возможность запрашивать события по конкретным характеристикам, например дате события, семейству веб-сайтов, в котором оно произошло, или типу события. Вместо этого создаются подписки на определенные рабочие нагрузки (например, SharePoint или Azure AD), по одной на клиент.

В следующих разделах рассматриваются наиболее распространенные вопросы клиентов, которые возникают при использовании API действий управления Office 365.

- [Вопросы о сторонних средствах и клиентах](#questions-about-third-party-tools-and-clients)

- [Включение ведения единого журнала аудита в Office 365](#enabling-unified-audit-logging-in-office-365)

- [Подключение к API](#connecting-to-the-api)

- [Проверка подписок](#checking-your-subscriptions)

- [Создание новой подписки](#creating-a-new-subscription)

- [Использование веб-перехватчиков](#using-webhooks)

- [Запрос больших двоичных объектов с контентом и регулирование](#requesting-content-blobs-and-throttling)

Мы покажем подборку простых скриптов PowerShell, которая может помочь вам найти ответы на наиболее распространенные вопросы пользователей и начать реализовывать собственное решение с использованием основных операций. В этих разделах описываются не все операции, но их полный список представлен в статье "Справочник по API действий управления Office 365".

### <a name="questions-about-third-party-tools-and-clients"></a>Вопросы о сторонних средствах и клиентах

Наиболее распространенная категория вопросов пользователей связана с использованием сторонних продуктов для скачивания и агрегирования данных аудита. В зависимости от стороннего продукта, у пользователей могут возникать трудности с настройкой либо перебои или несоответствия данных, предоставляемых в этих продуктах. Тут следует отметить, что первое действие, которое следует предпринять таким клиентам, — обратиться в службу поддержки поставщика соответствующего продукта. Как правило, причиной жалоб клиента является проблема со службой или конфигурацией поставщика для определенного клиента.

### <a name="enabling-unified-audit-logging-in-office-365"></a>Включение ведения единого журнала аудита в Office 365

Если вы только что настроили приложение, пытающееся использовать API действий управления, но оно не работает, убедитесь, что включено ведение единого журнала аудита для организации Office 365. Это выполняется путем включения журнала аудита Office 365. Инструкции см. в статье [Включение и отключение поиска в журнале аудита Office 365](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).

Если единый аудит не включен, как правило, вы будете получать сообщение об ошибке со следующей строкой: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`

### <a name="connecting-to-the-api"></a>Подключение к API

Большинство приложений подключаются к API с помощью обычного потока OAuth2 учетных данных клиента. Следовательно, для начала необходимо создать приложение Azure AD с разрешениями, необходимыми для доступа к данным API действий управления. В этой статье не представлены инструкции по регистрации приложения Azure AD. Дополнительные сведения см. в статье [Краткое руководство. Регистрация приложения в конечной точке Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).

#### <a name="azure-application-permissions"></a>Разрешения приложений Azure

В настоящее время для API действий управления Office 365 используются следующие три разрешения:

1. чтение данных о действиях в организации;

2. чтение сведений о работоспособности служб в организации;

3. чтение событий политик защиты от потери данных (DLP), в том числе при обнаружении конфиденциальной информации.

> [!NOTE]
> Необходимо включить как разрешения приложений, так и делегированные разрешения по крайней мере для первых двух из вышеуказанных наборов разрешений. Чтение событий политик защиты от потери данных потребуется, только если вас интересуют рабочие нагрузки DLP.

#### <a name="getting-an-access-token"></a>Получение маркера доступа

В приведенном ниже скрипте PowerShell используются идентификатор приложения и секрет клиента, чтобы получить токен OAuth2 из конечной точки проверки подлинности для API действий управления. Затем маркер доступа помещается в переменную массива `$headerParams`, которую вы вложите в свой HTTP-запрос. В качестве значения конечной точки API (в переменной $resource) используйте одно из указанных ниже значений в зависимости от плана подписки на Microsoft 365 или Office 365:

- План для предприятий: `manage.office.com`

- План для государственных организаций (GCC): `manage-gcc.office.com`

- План для государственных организаций (GCC High): `manage.office365.us`

- План для государственных организаций (DoD): `manage.protection.apps.mil`

```powershell
# Create app of type Web app / API in Azure AD, generate a Client Secret, and update the client id and client secret here
$ClientID = "<YOUR_APPLICATION_ID"
$ClientSecret = "<YOUR_CLIENT_SECRET>"
$loginURL = "https://login.microsoftonline.com/"
$tenantdomain = "<YOUR_DOMAIN>.onmicrosoft.com"
# Get the tenant GUID from Properties | Directory ID under the Azure Active Directory section. For $resource, use one of these endpoint values based on your subscription plan: Enterprise - manage.office.com; GCC - manage-gcc.office.com; GCC High: manage.office365.us; DoD: manage.protection.apps.mil
$TenantGUID = "<YOUR_TENANT_GUID>"
$resource = "https://<YOUR_API_ENDPOINT>"
# auth
$body = @{grant_type="client_credentials";resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body
$headerParams = @{'Authorization'="$($oauth.token_type) $($oauth.access_token)"} 
```

Переменная `$oauth` будет содержать объект отклика, у которого есть ряд свойств, в том числе маркер доступа. Вот пример такого отклика:

```json
token_type     : Bearer
expires_in     : 3599
ext_expires_in : 0
expires_on     : 1508285860
not_before     : 1508281960
resource       : https://manage.office.com
access_token   : eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyIsImtpZCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyJ9.eyJhdWQiOiJodHRwczov…
```

### <a name="checking-your-subscriptions"></a>Проверка подписок

Если произойдет перебой потока данных в имеющиеся клиент или решение, использующие API действий управления, вы можете подумать, что с вашей подпиской что-то не так. Чтобы проверить активные подписки, добавьте к предыдущему скрипту следующий код:

```powershell
Invoke-WebRequest -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/list" 
```

#### <a name="sample-response"></a>Пример отклика

```json
StatusCode        : 200
Status Description : OK
Content           : [{"contentType":"Audit.Exchange","status":"enabled","webhook":null},{"contentType":"Audit.SharePoint","status":"enabled","webhook":{"authId":"","address":"https://mvcwebapiwebhookreceiver.azurewebsite...
RawContent        : HTTP/1.1 200 OK
                    Pragma: no-cache
                    Content-Length: 266
                    Cache-Control: no-cache
                    Content-Type: application/json; charset=utf-8
                    Expires: -1
                    Server: Microsoft-IIS/8.5,Microsoft-IIS/8.5
                    X-AspNet-Versi...
Forms             : {}
Headers           : {[Pragma, no-cache], [Content-Length, 266], [Cache-Control, no-cache], [Content-Type, application/json; charset=utf-8]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 266
```

Это означает, что для клиента включены подписки Audit.Exchange и Audit.SharePoint. Для подписки Exchange веб-перехватчик не включен (null), а для подписки SharePoint включен веб-перехватчик с адресом зарегистрированной конечной точки.

### <a name="creating-a-new-subscription"></a>Создание новой подписки

Чтобы создать новую подписку, используйте операцию /start. Для конечной точки API используйте одно из указанных ниже значений в зависимости от плана подписки:

- План для предприятий: `manage.office.com`

- План для государственных организаций (GCC): `manage-gcc.office.com`

- План для государственных организаций (GCC High): `manage.office365.us`

- План для государственных организаций (DoD): `manage.protection.apps.mil`

```powershell
Invoke-WebRequest -Method Post -Headers $headerParams -Uri "https://<YOUR_API_ENDPOINT>/api/v1.0/$tenantGUID/activity/feed/subscriptions/start?contentType=Audit.AzureActiveDirectory"
```

> [!NOTE]
> Помните, что заголовок `$headerParams` был заполнен в первой части скрипта в разделе [Подключение к API](#connecting-to-the-api) этой статьи.

Приведенный выше код создаст новую подписку на тип контента Audit.AzureActiveDirectory, где для параметра webhook задано значение null. Затем вы можете проверить свои подписки, используя код из раздела [Проверка подписок](#checking-your-subscriptions) этой статьи.

## <a name="checking-content-availability"></a>Проверка доступности контента

Чтобы проверить, какие большие двоичные объекты с контентом были созданы за определенный период, вы можете добавить следующую строку в сценарий из раздела "Подключение к API".

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint"
```

В приведенном выше примере показано, как получить все уведомления о контенте, который стал доступен сегодня, то есть с 12:00 (в формате UTC) по текущее время. Если вы хотите указать другой временной период (учитывая, что максимальный период запроса составляет 24 часа), добавьте параметры *starttime* и *endtime* к URI. Пример:

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint&startTime=2017-10-13T00:00&endTime=2017-10-13T11:59"
```

> [!NOTE]
> Необходимо либо указать параметры *starttime* и *endtime*, либо не указывать ни одного из них.

```json
[{      "contentUri" : "https://<your_API_endpoint>/api/v1.0/<your_tenant_guid>/activity/feed/audit/20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentId" : "20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentType" : "Audit.SharePoint",
        "contentCreated" : "2017-10-13T18:00:51.748Z",
        "contentExpiration" : "2017-10-20T18:00:51.748Z",
}]
```

> [!IMPORTANT]
>
> - Свойство *contentUri* — это URI, из которого можно получить большой двоичный объект с контентом. Сам объект содержит сведения о 1–N событиях. Коллекция может содержать до 30 объектов JSON, но в этих 30 URI контента может быть указано намного больше событий.
>
> - Свойство *contentCreated* — это не дата создания события, соответствующего уведомлению. Это дата создания уведомления. События, описываемые в большом двоичном объекте, могли быть созданы задолго до создания самого объекта. Следовательно, из API невозможно напрямую запрашивать события, произошедшие за тот или иной период.

#### <a name="paging-contents-for-busy-tenants"></a>Разбиение контента на страницы для нагруженных клиентов

Во многих крупных клиентах Office 365 каждый час происходят тысячи событий. Если это верно для вашей организации, при попытке выполнить запрос для 24-часового периода, как в приведенном выше примере, может потребоваться получить больше уведомлений, чем можно вернуть в одном отклике. В этом случае вам потребуется реализовать некий логический цикл, каждый раз проверяя заголовки отклика на наличие значения заголовка **NextPageUrl:**. Дополнительные сведения см. в разделе "Разбивка на страницы" справочника по API действий управления Office 365.

```powershell
IF the NextPageUrl header is present in the response... 

THEN issue a new request substituting the Uri parameter in the above Invoke-WebRequest example for the value of the NextPageUrl header...
 
ELSE exit the loop
```

Этот повторяющийся код будет сложно тестировать, если у вас не очень активный клиент. В нашем тесте мы попытались выполнить в скрипте несколько тысяч операций обновления и не смогли создать достаточно большое количество уведомлений, чтобы потребовалось отправлять заголовок **NextPageUrl**.

### <a name="using-webhooks"></a>Использование веб-перехватчиков

Уведомление о создании больших двоичных объектов с контентом можно получить двумя способами. Подход с *отправкой* реализован при помощи конечной точки веб-перехватчика — веб-приложения, которое вы создаете и размещаете самостоятельно или на облачной платформе. Веб-перехватчик регистрируется во время создания подписки на тип контента для аудита. Вы также можете добавить регистрацию веб-перехватчика к имеющейся подписке, используя показанный ниже подход. Подход *pull* требует запрашивать данные за определенный временной диапазон (не более 24 часов) с помощью операции /content. В отклике будет указано, какие большие двоичные объекты были созданы за указанный период.

Прежде чем добавлять веб-перехватчик, учтите следующие две проблемы:

1. Корпорация Майкрософт отходит от использования веб-перехватчиков из-за сложности отладки и устранения неполадок. Как правило, размещается конечная точка WebApi, отвечающая на входящие запросы. Многие клиенты используют либо среды внешнего размещения (которые они не полностью контролируют), либо локальные среды (которые с трудом пропускают входящие HTTP-запросы). Сотрудники службы поддержки часто сталкиваются с проблемами, когда входящие запросы из конвейера аудита Office 365 блокируются брандмауэром или маршрутизатором. В этом случае API реализует алгоритм отхода, который может быть запутанным и приводить к отключению веб-перехватчика в подписке.

2. Веб-перехватчик должен быть готов сразу ответить на отклик о проверке после выполнения операции запуска. Если в приложении веб-перехватчика возникнет ошибка, то проверка завершится сбоем, а веб-перехватчик не будет включен. Сведения о схеме запросов на проверку см. в разделе "Проверка веб-перехватчиков" справочника по API действий управления Office 365. Вам следует серьезно отнестись к трудностям при создании готового к работе веб-перехватчика для ответа на уведомления API действий управления.

Если вы решите реализовать веб-перехватчик, его следует протестировать, чтобы убедиться, что конечная точка готова вернуть отклик HTTP 200 как на запрос проверки, так и на обычные запросы уведомлений перед операцией /start, указывающей, что конечная точка веб-перехватчика вызывается впервые. Как правило, для тестирования готовности используется макет запроса от API. Внимательно прочтите и соблюдайте инструкции из разделов Проверка веб-перехватчиков и Получение контента справочника по API действий управления Office 365, чтобы понять схему запросов этих двух типов.

Чтобы добавить подписку с конечной точкой веб-перехватчика, добавьте параметр body в запрос POST к конечной точке /start. Пример:

```json
$body = '{
    "webhook" : {
        "address": "https://webhook.myapp.com/o365/",
        "authId": "o365activityapinotification",
        "expiration": ""
    }}'
$uri = "https://manage.office.com/api/v1.0/$tenantGUID/activity/feed//subscriptions/start?contentType=Audit.SharePoint"
Invoke-RestMethod -Method Post -uri $uri -Headers $headerParams -Body $body
```

Сразу после этого вызова будет отправлен запрос на проверку по адресу `https://webhook.myapp.com/o365/ …`, где должен находиться готовый к ответу прослушиватель, как описано в разделе Проверка веб-перехватчиков справочника по API действий управления Office 365. В ответ прослушиватель отправит отклик HTTP 200. Если сразу после этого выполнить операцию /list, вы не увидите никакого значения параметра webhook, кроме null, пока результаты проверки не будут успешно возвращены.

#### <a name="checking-notifications-to-webhooks"></a>Проверка уведомлений для веб-перехватчиков

Важно понимать разницу между операциями /notifications и /content. Проверка уведомлений уместна только при наличии подписки на конечную точку веб-перехватчика. Эта операция сообщит вам, были ли успешными попытки отправки уведомлений вашему веб-перехватчику. Эту операцию не следует использовать для получения списка доступного контента. Для перекрестной проверки доступности контента относительно данных, уже полученных веб-перехватчиком, следует использовать операцию /content. Но сначала следует проверить наличие неудачных уведомлений с помощью операции /notifications.

### <a name="requesting-content-blobs-and-throttling"></a>Запрос больших двоичных объектов с контентом и регулирование

Получив список URI контента, необходимо запросить объекты, указанные этими URI. Ниже приведен пример запроса большого двоичного объекта с контентом (с использованием конечной точки API manage.office.com для организаций с планом для предприятий) с помощью PowerShell. В этом примере предполагается, что вы уже использовали предыдущий пример из раздела [Получение маркера доступа](#getting-an-access-token) этой статьи, чтобы получить маркер доступа, и заполнили переменную `$headerParams` должным образом.

```powershell
# Get a content blob
$uri = 'https://manage.office.com/api/v1.0/<<your-tenant-guid>>/activity/feed/audit/<<ContentID>$audit_sharepoint$Audit_SharePoint'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

Обратите внимание на следующие особенности переменной *$uri* в предыдущем примере:

- Мы использовали одинарные кавычки, чтобы среда PowerShell не интерпретировала символы *$* как переменные.

- Весь URI будет возвращен в свойстве *contentUri* отклика на предыдущий вызов конечной точки /content. Маркеры-заполнители представлены исключительно для примера.

При попытке получить доступные большие двоичные объекты многие пользователи (особенно работающие с нагруженными клиентами) сталкивались примерно с такими ошибками:

```json
Response Code 403: {'error':{'code':'AF429','message':'Too many requests. Method=GetBlob, PublisherId=00000000-0000-0000-0000-000000000000'}}
```

Скорее всего, это вызвано регулированием. Обратите внимание, что значение параметра PublisherId с большой вероятностью указывает, что клиент не указал параметр *PublisherIdentifier* в запросе. Кроме того, учтите, что правильное имя параметра — *PublisherIdentifier*, несмотря на то что в откликах об ошибке 403 указывается имя *PublisherId*.

> [!NOTE]
> В справочнике по API параметр *PublisherIdentifier* указан в каждой операции API, но его также следует включить в запрос GET к URL-адресу contentUri при получении объекта с контентом.

Если вы совершаете простые вызовы API для устранения неполадок (например, проверяете, активна ли определенная подписка), вы можете спокойно пропускать параметр *PublisherIdentifier*, но любой код, рассчитанный на рабочую среду, обязательно должен включать параметр *PublisherIdentifier* в каждый вызов.

Если вы реализуете клиентское приложение для клиента компании, то *PublisherIdentifier* — это GUID клиента. Если вы создаете приложение или надстройку для нескольких пользователей как независимый поставщик программного обеспечения, то параметр *PublisherIdentifier* должен содержать GUID клиента независимого поставщика, а не GUID клиента компании пользователя.

Включив допустимый параметр *PublisherIdentifier*, вы получите пул, поддерживающий до 60 тысяч запросов в минуту для каждого клиента. Это исключительно большое количество запросов. Однако если не включить параметр *PublisherIdentifier*, вам будет предоставлен общий пул, рассчитанный на 60 тысяч запросов в минуту для всех клиентов. В этом случае ваши вызовы наверняка будут регулироваться. Во избежание этого вы можете запросить большой двоичный объект с контентом при помощи параметра *PublisherIdentifier* следующим образом:

```json
$contentUri = ($response.Content | ConvertFrom-Json).contentUri[0]
$uri = $contentUri + '?PublisherIdentifier=82b24b6d-0591-4604-827b-705d55d0992f'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

В предыдущем примере предполагается, что переменная *$response* содержит отклик на запрос к конечной точке /content, а переменная *$headerParams* включает действительный маркер доступа. Скрипт получает из отклика первый элемент массива URI контента, а затем отправляет запрос GET, чтобы скачать этот объект и добавить переменную *$contents*. Скорее всего, код циклически просмотрит коллекцию contentUri, отправляя запрос GET для каждого значения *contentUri*.
